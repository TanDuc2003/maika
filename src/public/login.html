<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Facebook</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

</head>

<body class="bg-gradient-to-r from-cyan-500 to-blue-500 h-screen flex items-center justify-center w-full"
    x-data="{ email: '', isEmailValid: false }">
    <div class="bg-white shadow-md rounded-lg px-[24px] py-[48px] w-full flex flex-col items-center"
        style="max-width: 560px;">
        <h2 class="text-2xl font-bold mb-4 w-full">Login</h2>
        <!-- Email Input -->
        <div class="mb-4 w-full" x-data="{ email: '', isEmailValid: false }">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
                Email Address
            </label>
            <input id="email" @input="validateEmail()"
                class="w-full shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                type="email" placeholder="Enter your email">
            <p class="isShowEmail text-gray-600 text-xs mt-2 text-red-600" x-show="false">Invalid email address.</p>
        </div>
        <!-- Login Button -->
        <div class="flex items-center justify-center w-full">
            <button @click="fbLogin()" id="isLoading"
                class="w-1/2 bg-gradient-to-r from-sky-500 to-indigo-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                <div style="display: none"
                    class="loadingTrue inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-e-transparent align-[-0.125em] text-surface motion-reduce:animate-[spin_1.5s_linear_infinite] dark:text-white"
                    role="status">
                    <span
                        class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
                </div>
                <span class="loadingFalse">Login with Facebook</span>
            </button>
        </div>
    </div>

    <script>

        //----> BASE - CALL API
        async function fetchAPI(endPoint, method, dataPost) {
            const baseUrl = "https://localhost";
            const option = {
                method: method ?? "GET",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataPost)
            };
            try {
                const res = await fetch(baseUrl + endPoint, option);
                if (!res?.ok) {
                    console.log("fetchAPI")
                }
                return res.json();
            } catch (error) {
                console.log("errorfetchAPI", error)
            }
        }


        //----> API - FaceBook 
        function init() {
            window.fbAsyncInit = function () {
                FB.init({
                    appId: '617274822270137',
                    cookie: true,
                    xfbml: true,
                    version: 'v19.0'
                });

                FB.getLoginStatus(function (response) {
                    console.log(JSON.stringify(response, null, 2));
                    if (response.status === 'connected') {
                        var accessToken = response.authResponse.accessToken;
                        getFbUserData();
                    } else if (response.status === 'not_authorized') {
                        console.log("Not authorized")
                    } else {
                        console.log("Not logged in to Facebook")
                    }
                });
            };

            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "//connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        }
        init();

        function fbLogin() {
            let urlParams = new URLSearchParams(window.location.search);
            let permissions = urlParams.get('permissions') || 'public_profile,pages_manage_metadata,pages_show_list,pages_messaging';
            document.querySelector("#isLoading .loadingTrue").style.display = "inline-block";
            document.querySelector("#isLoading .loadingFalse").style.display = "none";
            FB.login(function (response) {
                if (!response?.authResponse) {
                    return handleLoginFailure();
                }
                const { userID, accessToken } = response.authResponse;
                handleUserLogin({ userID, accessToken });
            }, { scope: permissions });

        };

        async function handleUserLogin(params) {
            try {
                const { userID, accessToken } = params;
                const res = await getLongAccessTokenUser(accessToken);
                if (res) {
                    const resLong = await getFbUserData(res);
                    if (resLong) {
                        processUserPages(resLong.data, userID);
                    }
                }
                document.querySelector("#isLoading .loadingFalse").style.display = "inline-block";
                document.querySelector("#isLoading .loadingTrue").style.display = "none";
                window.location.href = 'success.html';
            } catch (error) {
                console.log("error handleUserLogin", error)
            }
        }

        async function processUserPages(pagesData, userID) {
            const promises = pagesData.map((item) => {
                return getLongAccessTokenPage(userID, item.access_token)
            });
            const valueEmail = document.getElementById('email').value;
            const res = await Promise.all(promises);
            const listPage = res.map((item, index) => ({
                page_id: item.data[index].id,
                access_token: item.data[index].access_token,
                name: item.data[index].name,
            }))
            postPageData({
                email: valueEmail,
                userId: userID,
                listPage
            });

        }

        function handleLoginFailure() {
            document.querySelector("#isLoading .loadingFalse").style.display = "inline-block";
            document.querySelector("#isLoading .loadingTrue").style.display = "none";
        }
        
        async function postPageData(dataPost) {
            try {
                const res = await fetchAPI("/post-page", "POST", dataPost);
                console.log(res);
            } catch (error) {
                console.log('Error PostPageData:', error);
            }
        }

        function getLongAccessTokenPage(userId, longAccessTokenUser) {
            return new Promise((resolve, reject) => {
                const requestData = {
                    access_token: longAccessTokenUser,
                };
                FB.api(`/${userId}/accounts `, "GET", requestData, (function (response) {
                    if (response) {
                        resolve(response);
                    } else {
                        reject(response.message);
                    }
                }));
            })
        }


        async function getLongAccessTokenUser(accessTokenUser) {
            const datapost = {
                access_token: accessTokenUser
            }
            try {
                const res = await fetchAPI("/getLongTokenUser", "POST", datapost)
                console.log(res.accessTokenUser);
                return res.accessTokenUser;
            } catch (error) {
                console.log('Error getLongAccessTokenUser:', error);
            }
        }



        function getFbUserData(longAccessTokenUser) {
            return new Promise((resolve, reject) => {
                let requestData = {
                    fields: "id,access_token,name,link",
                    access_token: longAccessTokenUser
                };
                FB.api('/me/accounts', 'GET', requestData,
                    function (response) {
                        if (response) {
                            resolve(response);
                        } else {
                            reject(response.message);
                        }
                    }
                );
            })
        }

        function fbLogout() {
            FB.getLoginStatus(function (response) {
                if (response && response.status === 'connected') {
                    FB.logout(function (response) {
                        document.location.reload();
                    });
                } else if (response.status === 'not_authorized') {
                    FB.logout(function (response) {
                        document.location.reload();
                    });
                }
            });
        }
        function validateEmail() {
            const emailInput = document.getElementById('email').value;
            const res = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
            const isRegex = res.test(String(emailInput).toLowerCase());
            return document.querySelector(".isShowEmail").style.display = isRegex ? "none" : "inline-block";
        }
    </script>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
</body>

</html>